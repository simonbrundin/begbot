import{D as U,m as V,c as i,a as e,d as O,H as b,F as B,G as E,t as p,o as a,I as R,s as h,x as G,l as q,J as X,K as J,z as s,T as Q,U as W,P as Y,L,O as A,M as Z,p as F}from"./DJ5wksKX.js";import{u as ee}from"./dQMjavNy.js";import"./DU5dWS6F.js";const te={class:"card p-4 mt-4"},se={class:"flex justify-between items-center mb-3"},le={class:"flex items-center gap-3"},ae={key:0,class:"flex items-center gap-1 text-xs text-emerald-400"},ne=["disabled"],oe={key:0,class:"text-slate-600 italic"},re={class:"text-slate-500 shrink-0"},ie={class:"text-slate-300 break-all"},ce={key:0,class:"mt-2 text-sm text-red-400"},ue=U({__name:"ScraperLogConsole",props:{logs:{},isConnected:{type:Boolean},error:{}},emits:["clear"],setup(f){const c=f,v=h();V(()=>c.logs.length,()=>{G(()=>{v.value&&(v.value.scrollTop=v.value.scrollHeight)})});const k=u=>new Date(u).toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),g=u=>{switch(u){case"error":return"text-red-400";case"warning":return"text-amber-400";default:return"text-blue-400"}};return(u,m)=>(a(),i("div",te,[e("div",se,[m[2]||(m[2]=e("h3",{class:"text-sm font-medium text-slate-300"},"Scraper-logg",-1)),e("div",le,[f.isConnected?(a(),i("span",ae,[...m[1]||(m[1]=[e("span",{class:"w-2 h-2 bg-emerald-400 rounded-full animate-pulse"},null,-1),O(" Live ",-1)])])):b("",!0),e("button",{onClick:m[0]||(m[0]=n=>u.$emit("clear")),class:"text-xs text-slate-400 hover:text-slate-300",disabled:f.logs.length===0}," Rensa ",8,ne)])]),e("div",{ref_key:"logContainer",ref:v,class:"bg-slate-950 rounded-lg p-3 font-mono text-xs h-64 overflow-y-auto space-y-1"},[f.logs.length===0?(a(),i("div",oe," Väntar på loggmeddelanden... ")):b("",!0),(a(!0),i(B,null,E(f.logs,(n,d)=>(a(),i("div",{key:d,class:"flex gap-2"},[e("span",re,p(k(n.timestamp)),1),e("span",{class:R(["shrink-0 w-14",g(n.level)])}," ["+p(n.level.toUpperCase())+"] ",3),e("span",ie,p(n.message),1)]))),128))],512),f.error?(a(),i("div",ce,p(f.error),1)):b("",!0)]))}});function de(f){const c=h([]),v=h(!1),k=h(null);let g=null,u=0;const m=3,n=()=>{if(!f.value)return;c.value=[],k.value=null,u=0;const $=`${X().public.apiBase||"http://localhost:8081"}/api/fetch-ads/logs/${f.value}`;console.log("Connecting to SSE:",$),g=new EventSource($),g.onopen=()=>{console.log("SSE connection opened"),v.value=!0,k.value=null,u=0},g.onmessage=_=>{console.log("SSE message received:",_.data);try{const S=JSON.parse(_.data);c.value.push(S)}catch(S){console.error("Failed to parse log entry:",S)}},g.onerror=_=>{console.error("SSE error:",_),v.value=!1,u<m?(u++,console.log(`Reconnecting... attempt ${u}`),setTimeout(()=>{d(),n()},1e3*u)):k.value="Anslutningen bröts. Försök uppdatera sidan."}},d=()=>{g&&(g.close(),g=null),v.value=!1},o=()=>{c.value=[]};return V(f,(x,w)=>{console.log("JobId changed:",x,"old:",w),x&&x!==w?(d(),n()):x||(d(),c.value=[])}),q(()=>{d()}),{logs:c,isConnected:v,error:k,connect:n,disconnect:d,clearLogs:o}}const pe=globalThis.setInterval,me={class:"flex justify-between items-center mb-6"},ve={class:"flex gap-2"},ge=["disabled"],fe={key:0,class:"card p-4 mb-6"},he={class:"flex justify-between items-center mb-2"},be={class:"font-medium text-slate-100"},xe={class:"text-sm text-slate-400"},ke={class:"w-full bg-slate-700 rounded-full h-2.5"},ye={key:0,class:"text-sm text-slate-400 mt-2"},_e={key:1,class:"text-sm text-emerald-400 mt-2"},we={key:2,class:"text-sm text-red-400 mt-2"},Se={key:2,class:"card overflow-hidden mt-6"},Ce={class:"table"},$e={class:"font-medium text-slate-100"},Te={class:"text-sm text-slate-400 truncate max-w-xs"},Le=["onClick"],Fe=["onClick"],Be={key:3,class:"text-center py-12 text-slate-500"},Ee={key:4,class:"fixed inset-0 bg-black/70 flex items-center justify-center z-50"},Me={class:"bg-slate-800 rounded-lg p-6 w-full max-w-lg border border-slate-700"},Ae=["value"],Ue={class:"flex justify-end gap-2 pt-4"},Ne=U({__name:"scraping",setup(f){const c=ee(),v=h([]),k=F(()=>v.value.length>0),g=h([]),u=h(!1),m=h(!1),n=h(!1),d=h(null),o=h(null);let x=null;const{logs:w,isConnected:$,error:_,clearLogs:S}=de(d),y=h({description:"",url:"",marketplace_id:null,is_active:!0}),M=F(()=>o.value?o.value.progress:0),N=F(()=>{if(!o.value)return"Väntar";switch(o.value.status){case"pending":return"Startar...";case"running":return"Hämtar annonser...";case"completed":return"Klar!";case"failed":return"Misslyckades";default:return"Väntar"}}),P=async()=>{if(!n.value){n.value=!0,o.value=null;try{const r=await c.post("/fetch-ads",{});d.value=r.job_id,x=pe(async()=>{if(!d.value){T();return}try{const t=await c.get(`/fetch-ads/status/${d.value}`);o.value=t,t&&(t.status==="completed"||t.status==="failed")&&(T(),n.value=!1,setTimeout(()=>{d.value=null,o.value=null},5e3),t.status==="completed"&&await C())}catch(t){console.error("Failed to fetch status:",t),T(),n.value=!1}},1e3)}catch(r){console.error("Failed to start fetch:",r),n.value=!1,d.value=null,o.value={status:"failed",progress:0,total_queries:0,completed_queries:0,current_query:"",ads_found:0,error:"Kunde inte starta hämtning"}}}},T=()=>{x&&(clearInterval(x),x=null)},C=async()=>{u.value=!0;try{const[r,t]=await Promise.all([c.get("/search-terms"),c.get("/marketplaces")]);v.value=[...r],g.value=[...t]}catch(r){console.error("Failed to fetch data:",r)}finally{u.value=!1}},j=r=>r&&g.value.find(t=>t.id===r)?.name||"Unknown",H=async()=>{try{await c.post("/search-terms",y.value),m.value=!1,y.value={description:"",url:"",marketplace_id:null,is_active:!0},await C()}catch(r){console.error("Failed to save search term:",r)}},D=async r=>{try{await c.put(`/search-terms/${r.id}`,{is_active:!r.is_active}),await C()}catch(t){console.error("Failed to toggle active:",t)}},z=async r=>{if(confirm("Ta bort detta sökord?"))try{await c.delete(`/search-terms/${r}`),await C()}catch(t){console.error("Failed to delete term:",t)}};return J(C),q(()=>{T()}),(r,t)=>{const I=ue;return a(),i("div",null,[e("div",me,[t[5]||(t[5]=e("h1",{class:"page-header"},"Sökord",-1)),e("div",ve,[e("button",{onClick:P,disabled:s(n),class:"btn btn-primary"},p(s(n)?"Hämtar...":"Hämta annonser"),9,ge),e("button",{onClick:t[0]||(t[0]=l=>m.value=!0),class:"btn btn-secondary"}," Lägg till sökord ")])]),s(n)||s(o)?(a(),i("div",fe,[e("div",he,[e("span",be,p(s(N)),1),e("span",xe,p(s(M))+"%",1)]),e("div",ke,[e("div",{class:"bg-primary-500 h-2.5 rounded-full transition-all duration-300",style:Q({width:s(M)+"%"})},null,4)]),s(o)?.current_query?(a(),i("p",ye," Bearbetar: "+p(s(o).current_query),1)):b("",!0),s(o)?.ads_found!==void 0&&s(o).ads_found>0?(a(),i("p",_e," Hittade "+p(s(o).ads_found)+" annonser ",1)):b("",!0),s(o)?.error?(a(),i("p",we," Fel: "+p(s(o).error),1)):b("",!0)])):b("",!0),s(d)?(a(),W(I,{key:1,logs:s(w),"is-connected":s($),error:s(_),onClear:s(S)},null,8,["logs","is-connected","error","onClear"])):b("",!0),s(k)?(a(),i("div",Se,[e("table",Ce,[t[6]||(t[6]=e("thead",null,[e("tr",null,[e("th",null,"Beskrivning"),e("th",null,"URL"),e("th",null,"Marknadsplats"),e("th",null,"Status"),e("th")])],-1)),e("tbody",null,[(a(!0),i(B,null,E(s(v),l=>(a(),i("tr",{key:l.id},[e("td",$e,p(l.description),1),e("td",Te,p(l.url),1),e("td",null,p(j(l.marketplace_id)),1),e("td",null,[e("button",{onClick:K=>D(l),class:R(l.is_active?"badge badge-success":"badge")},p(l.is_active?"Aktiv":"Inaktiv"),11,Le)]),e("td",null,[e("button",{onClick:K=>z(l.id),class:"text-red-400 hover:text-red-300 text-sm"}," Ta bort ",8,Fe)])]))),128))])])])):b("",!0),s(k)?b("",!0):(a(),i("div",Be," Inga sökord konfigurerade. Lägg till ditt första för att börja skrapa! ")),s(m)?(a(),i("div",Ee,[e("div",Me,[t[12]||(t[12]=e("h2",{class:"text-xl font-bold text-slate-100 mb-4"},"Lägg till sökord",-1)),e("form",{onSubmit:Y(H,["prevent"]),class:"space-y-4"},[e("div",null,[t[7]||(t[7]=e("label",{class:"label"},"Beskrivning",-1)),L(e("input",{"onUpdate:modelValue":t[1]||(t[1]=l=>s(y).description=l),type:"text",class:"input",placeholder:"t.ex., iPhone 15 Pro",required:""},null,512),[[A,s(y).description]])]),e("div",null,[t[8]||(t[8]=e("label",{class:"label"},"Sök-URL",-1)),L(e("input",{"onUpdate:modelValue":t[2]||(t[2]=l=>s(y).url=l),type:"url",class:"input",placeholder:"https://www.blocket.se/...",required:""},null,512),[[A,s(y).url]])]),e("div",null,[t[10]||(t[10]=e("label",{class:"label"},"Marknadsplats",-1)),L(e("select",{"onUpdate:modelValue":t[3]||(t[3]=l=>s(y).marketplace_id=l),class:"input"},[t[9]||(t[9]=e("option",{value:""},"Välj marknadsplats...",-1)),(a(!0),i(B,null,E(s(g),l=>(a(),i("option",{key:l.id,value:l.id},p(l.name),9,Ae))),128))],512),[[Z,s(y).marketplace_id]])]),e("div",Ue,[e("button",{type:"button",onClick:t[4]||(t[4]=l=>m.value=!1),class:"btn btn-secondary"}," Avbryt "),t[11]||(t[11]=e("button",{type:"submit",class:"btn btn-primary"},"Lägg till",-1))])],32)])])):b("",!0)])}}});export{Ne as default};
