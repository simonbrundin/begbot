import{C as M,l as V,c as r,a as e,d as X,G as y,F,E,t as u,o,H as U,r as f,v as Q,k as N,I as W,J as Y,y as s,S as Z,T as ee,O as te,K as A,N as j,L as se,n as L}from"./BEFdwPCg.js";import{u as le}from"./DPGkDMz_.js";import"./BMadXahP.js";const ae={class:"card p-4 mt-4"},ne={class:"flex justify-between items-center mb-3"},oe={class:"flex items-center gap-3"},re={key:0,class:"flex items-center gap-1 text-xs text-emerald-400"},ce=["disabled"],ie={key:0,class:"text-slate-600 italic"},ue={class:"text-slate-500 shrink-0"},de={class:"text-slate-300 break-all"},ve={key:0,class:"mt-2 text-sm text-red-400"},pe=M({__name:"ScraperLogConsole",props:{logs:{},isConnected:{type:Boolean},error:{}},emits:["clear"],setup(b){const i=b,g=f();V(()=>i.logs.length,()=>{Q(()=>{g.value&&(g.value.scrollTop=g.value.scrollHeight)})});const _=d=>new Date(d).toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),m=d=>{switch(d){case"error":return"text-red-400";case"warning":return"text-amber-400";default:return"text-blue-400"}};return(d,v)=>(o(),r("div",ae,[e("div",ne,[v[2]||(v[2]=e("h3",{class:"text-sm font-medium text-slate-300"},"Scraper-logg",-1)),e("div",oe,[b.isConnected?(o(),r("span",re,[...v[1]||(v[1]=[e("span",{class:"w-2 h-2 bg-emerald-400 rounded-full animate-pulse"},null,-1),X(" Live ",-1)])])):y("",!0),e("button",{onClick:v[0]||(v[0]=c=>d.$emit("clear")),class:"text-xs text-slate-400 hover:text-slate-300",disabled:b.logs.length===0}," Rensa ",8,ce)])]),e("div",{ref_key:"logContainer",ref:g,class:"bg-slate-950 rounded-lg p-3 font-mono text-xs h-64 overflow-y-auto space-y-1"},[b.logs.length===0?(o(),r("div",ie," Väntar på loggmeddelanden... ")):y("",!0),(o(!0),r(F,null,E(b.logs,(c,p)=>(o(),r("div",{key:p,class:"flex gap-2"},[e("span",ue,u(_(c.timestamp)),1),e("span",{class:U(["shrink-0 w-14",m(c.level)])}," ["+u(c.level.toUpperCase())+"] ",3),e("span",de,u(c.message),1)]))),128))],512),b.error?(o(),r("div",ve,u(b.error),1)):y("",!0)]))}}),ge=Object.assign(pe,{__name:"ScraperLogConsole"});function me(b){const i=f([]),g=f(!1),_=f(null);let m=null,d=0;const v=3,c=()=>{if(!b.value)return;i.value=[],_.value=null,d=0;const $=`${W().public.apiBase||"http://localhost:8081"}/api/fetch-ads/logs/${b.value}`;console.log("Connecting to SSE:",$),m=new EventSource($),m.onopen=()=>{console.log("SSE connection opened"),g.value=!0,_.value=null,d=0},m.onmessage=C=>{console.log("SSE message received:",C.data);try{const w=JSON.parse(C.data);i.value.push(w)}catch(w){console.error("Failed to parse log entry:",w)}},m.onerror=C=>{console.error("SSE error:",C),g.value=!1,d<v?(d++,console.log(`Reconnecting... attempt ${d}`),setTimeout(()=>{p(),c()},1e3*d)):_.value="Anslutningen bröts. Försök uppdatera sidan."}},p=()=>{m&&(m.close(),m=null),g.value=!1},h=()=>{i.value=[]};return V(b,(l,x)=>{console.log("JobId changed:",l,"old:",x),l&&l!==x?(p(),c()):l||(p(),i.value=[])}),N(()=>{p()}),{logs:i,isConnected:g,error:_,connect:c,disconnect:p,clearLogs:h}}const fe=globalThis.setInterval,be={class:"flex justify-between items-center mb-6"},he={class:"flex gap-2"},ye=["disabled"],_e={key:0,class:"card p-4 mb-6"},xe={class:"flex justify-between items-center mb-2"},ke={class:"font-medium text-slate-100"},Ce={class:"flex items-center gap-3"},we={class:"text-sm text-slate-400"},Se=["disabled"],$e={class:"w-full bg-slate-700 rounded-full h-2.5"},Te={key:0,class:"text-sm text-slate-400 mt-2"},Le={key:1,class:"text-sm text-emerald-400 mt-2"},Ae={key:2,class:"text-sm text-red-400 mt-2"},Fe={key:2,class:"card overflow-hidden mt-6"},Ee={class:"table"},Be={class:"font-medium text-slate-100"},je={class:"text-sm text-slate-400 truncate max-w-xs"},Me=["onClick"],Ve=["onClick"],Ue={key:3,class:"text-center py-12 text-slate-500"},Ne={key:4,class:"fixed inset-0 bg-black/70 flex items-center justify-center z-50"},Pe={class:"bg-slate-800 rounded-lg p-6 w-full max-w-lg border border-slate-700"},Re=["value"],qe={class:"flex justify-end gap-2 pt-4"},Oe=M({__name:"scraping",setup(b){const i=le(),g=f([]),_=L(()=>g.value.length>0),m=f([]),d=f(!1),v=f(!1),c=f(!1),p=f(!1),h=f(null),l=f(null);let x=null;const{logs:$,isConnected:C,error:w,clearLogs:P}=me(h),k=f({description:"",url:"",marketplace_id:null,is_active:!0}),B=L(()=>l.value?l.value.progress:0),R=L(()=>{if(!l.value)return"Väntar";switch(l.value.status){case"pending":return"Startar...";case"running":return"Hämtar annonser...";case"completed":return"Klar!";case"failed":return"Misslyckades";case"cancelled":return"Avbrutet";default:return"Väntar"}}),q=L(()=>l.value&&(l.value.status==="pending"||l.value.status==="running")),I=async()=>{if(!c.value){c.value=!0,l.value=null;try{const a=await i.post("/fetch-ads",{});h.value=a.job_id,x=fe(async()=>{if(!h.value){T();return}try{const t=await i.get(`/fetch-ads/status/${h.value}`);l.value=t,t&&(t.status==="completed"||t.status==="failed"||t.status==="cancelled")&&(T(),c.value=!1,p.value=!1,setTimeout(()=>{h.value=null,l.value=null},5e3),t.status==="completed"&&await S())}catch(t){console.error("Failed to fetch status:",t),T(),c.value=!1}},1e3)}catch(a){console.error("Failed to start fetch:",a),c.value=!1,h.value=null,l.value={status:"failed",progress:0,total_queries:0,completed_queries:0,current_query:"",ads_found:0,error:"Kunde inte starta hämtning"}}}},T=()=>{x&&(clearInterval(x),x=null)},H=async()=>{if(console.log("Cancel button clicked, jobId:",h.value),!h.value||p.value){console.log("Cannot cancel - no jobId or already cancelling");return}p.value=!0;try{console.log("Calling cancel API..."),await i.post(`/fetch-ads/cancel/${h.value}`,{}),console.log("Cancel API called successfully")}catch(a){console.error("Failed to cancel job:",a),p.value=!1}},S=async()=>{d.value=!0;try{const[a,t]=await Promise.all([i.get("/search-terms"),i.get("/marketplaces")]);g.value=[...a],m.value=[...t]}catch(a){console.error("Failed to fetch data:",a)}finally{d.value=!1}},D=a=>a&&m.value.find(t=>t.id===a)?.name||"Unknown",O=async()=>{try{await i.post("/search-terms",k.value),v.value=!1,k.value={description:"",url:"",marketplace_id:null,is_active:!0},await S()}catch(a){console.error("Failed to save search term:",a)}},z=async a=>{try{await i.put(`/search-terms/${a.id}`,{is_active:!a.is_active}),await S()}catch(t){console.error("Failed to toggle active:",t)}},K=async a=>{if(confirm("Ta bort detta sökord?"))try{await i.delete(`/search-terms/${a}`),await S()}catch(t){console.error("Failed to delete term:",t)}};return Y(S),N(()=>{T()}),(a,t)=>{const J=ge;return o(),r("div",null,[e("div",be,[t[5]||(t[5]=e("h1",{class:"page-header"},"Sökord",-1)),e("div",he,[e("button",{onClick:I,disabled:s(c),class:"btn btn-primary"},u(s(c)?"Hämtar...":"Hämta annonser"),9,ye),e("button",{onClick:t[0]||(t[0]=n=>v.value=!0),class:"btn btn-secondary"}," Lägg till sökord ")])]),s(c)||s(l)?(o(),r("div",_e,[e("div",xe,[e("span",ke,u(s(R)),1),e("div",Ce,[e("span",we,u(s(B))+"%",1),s(q)?(o(),r("button",{key:0,onClick:H,disabled:s(p),class:"btn btn-danger text-xs py-1 px-3"},u(s(p)?"Avbryter...":"Avbryt"),9,Se)):y("",!0)])]),e("div",$e,[e("div",{class:"bg-primary-500 h-2.5 rounded-full transition-all duration-300",style:Z({width:s(B)+"%"})},null,4)]),s(l)?.current_query?(o(),r("p",Te," Bearbetar: "+u(s(l).current_query),1)):y("",!0),s(l)?.ads_found!==void 0&&s(l).ads_found>0?(o(),r("p",Le," Hittade "+u(s(l).ads_found)+" annonser ",1)):y("",!0),s(l)?.error?(o(),r("p",Ae," Fel: "+u(s(l).error),1)):y("",!0)])):y("",!0),s(h)?(o(),ee(J,{key:1,logs:s($),"is-connected":s(C),error:s(w),onClear:s(P)},null,8,["logs","is-connected","error","onClear"])):y("",!0),s(_)?(o(),r("div",Fe,[e("table",Ee,[t[6]||(t[6]=e("thead",null,[e("tr",null,[e("th",null,"Beskrivning"),e("th",null,"URL"),e("th",null,"Marknadsplats"),e("th",null,"Status"),e("th")])],-1)),e("tbody",null,[(o(!0),r(F,null,E(s(g),n=>(o(),r("tr",{key:n.id},[e("td",Be,u(n.description),1),e("td",je,u(n.url),1),e("td",null,u(D(n.marketplace_id)),1),e("td",null,[e("button",{onClick:G=>z(n),class:U(n.is_active?"badge badge-success":"badge")},u(n.is_active?"Aktiv":"Inaktiv"),11,Me)]),e("td",null,[e("button",{onClick:G=>K(n.id),class:"text-red-400 hover:text-red-300 text-sm"}," Ta bort ",8,Ve)])]))),128))])])])):y("",!0),s(_)?y("",!0):(o(),r("div",Ue," Inga sökord konfigurerade. Lägg till ditt första för att börja skrapa! ")),s(v)?(o(),r("div",Ne,[e("div",Pe,[t[12]||(t[12]=e("h2",{class:"text-xl font-bold text-slate-100 mb-4"},"Lägg till sökord",-1)),e("form",{onSubmit:te(O,["prevent"]),class:"space-y-4"},[e("div",null,[t[7]||(t[7]=e("label",{class:"label"},"Beskrivning",-1)),A(e("input",{"onUpdate:modelValue":t[1]||(t[1]=n=>s(k).description=n),type:"text",class:"input",placeholder:"t.ex., iPhone 15 Pro",required:""},null,512),[[j,s(k).description]])]),e("div",null,[t[8]||(t[8]=e("label",{class:"label"},"Sök-URL",-1)),A(e("input",{"onUpdate:modelValue":t[2]||(t[2]=n=>s(k).url=n),type:"url",class:"input",placeholder:"https://www.blocket.se/...",required:""},null,512),[[j,s(k).url]])]),e("div",null,[t[10]||(t[10]=e("label",{class:"label"},"Marknadsplats",-1)),A(e("select",{"onUpdate:modelValue":t[3]||(t[3]=n=>s(k).marketplace_id=n),class:"input"},[t[9]||(t[9]=e("option",{value:""},"Välj marknadsplats...",-1)),(o(!0),r(F,null,E(s(m),n=>(o(),r("option",{key:n.id,value:n.id},u(n.name),9,Re))),128))],512),[[se,s(k).marketplace_id]])]),e("div",qe,[e("button",{type:"button",onClick:t[4]||(t[4]=n=>v.value=!1),class:"btn btn-secondary"}," Avbryt "),t[11]||(t[11]=e("button",{type:"submit",class:"btn btn-primary"},"Lägg till",-1))])],32)])])):y("",!0)])}}});export{Oe as default};
