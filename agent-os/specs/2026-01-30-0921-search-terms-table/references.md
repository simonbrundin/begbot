# References: Search Terms Feature

## Code References

### Existing Schema
File: `schema_improved.sql`
- `marketplaces` table: Reference for marketplace foreign key
- `listings` table: Target table for discovered ads
- `conditions` table: Reference for condition values

### Existing Models
File: `internal/models/models.go`
- `Marketplace` struct: Marketplace data model
- `Listing` struct: Listing data model
- `Condition` struct: Condition enum values

### Existing Database Layer
File: `internal/db/postgres.go`
- `SaveListing` method: Pattern for inserting listings
- `GetListingByProductID` method: Pattern for querying listings
- Migration pattern: `CREATE TABLE IF NOT EXISTS ...`

### Existing Service Layer
File: `internal/services/marketplace.go`
- `MarketplaceService` struct: Service pattern
- `RawAd` struct: Ad data format
- `FetchAds` method: Entry point for scraping
- `ConvertToPotentialItem` method: Conversion pattern

### Configuration
File: `config.yaml`
- Scraping configuration structure
- Marketplace enable/disable pattern
- Timeout configuration

### Product Configuration
File: `products/phones.yaml`
- Example URL structure for Blocket
- Query parameter patterns

## Database Patterns

### Table Creation Pattern
```sql
CREATE TABLE IF NOT EXISTS "table_name" (
    "id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "field" TEXT,
    PRIMARY KEY("id")
);
```

### Index Pattern
```sql
CREATE INDEX "idx_table_field"
ON "table_name" ("field");
```

### Foreign Key Pattern
```sql
ALTER TABLE "table_name"
ADD FOREIGN KEY("field_id") REFERENCES "other_table"("id")
ON UPDATE NO ACTION ON DELETE NO ACTION;
```

## Go Patterns

### Model Definition
```go
type Model struct {
    ID   int64  `json:"id" db:"id"`
    Name string `json:"name" db:"name"`
}
```

### Database Method
```go
func (p *Postgres) SaveModel(ctx context.Context, model *Model) error {
    query := `INSERT INTO ... RETURNING id`
    return p.db.QueryRowContext(ctx, query, ...).Scan(&model.ID)
}
```

### Service Pattern
```go
type Service struct {
    cfg *config.Config
}

func NewService(cfg *config.Config) *Service {
    return &Service{cfg: cfg}
}
```
